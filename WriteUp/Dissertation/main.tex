% Template for a Computer Science Tripos Part II project dissertation
\documentclass[12pt,a4paper]{report}
% Gives a better chapter
\newcommand{\newchapter}[2]{
    \setcounter{chapter}{#1}
    \setcounter{section}{0}
    \chapter*{#2}
    \addcontentsline{toc}{chapter}{#1 #2}
}

\usepackage{titlesec}

\titleclass{\subsubsubsection}{straight}[\subsection]

\newcounter{subsubsubsection}[subsubsection]
\renewcommand\thesubsubsubsection{\thesubsubsection.\arabic{subsubsubsection}}

\titleformat{\subsubsubsection}
  {\normalfont\normalsize\bfseries}{\thesubsubsubsection}{1em}{}
\titlespacing*{\subsubsubsection}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\makeatletter
\renewcommand\paragraph{\@startsection{paragraph}{5}{\z@}%
  {3.25ex \@plus1ex \@minus.2ex}%
  {-1em}%
  {\normalfont\normalsize\bfseries}}
\renewcommand\subparagraph{\@startsection{subparagraph}{6}{\parindent}%
  {3.25ex \@plus1ex \@minus .2ex}%
  {-1em}%
  {\normalfont\normalsize\bfseries}}
\def\toclevel@subsubsubsection{4}
\def\toclevel@paragraph{5}
\def\toclevel@paragraph{6}
\def\l@subsubsubsection{\@dottedtocline{4}{7em}{4em}}
\def\l@paragraph{\@dottedtocline{5}{10em}{5em}}
\def\l@subparagraph{\@dottedtocline{6}{14em}{6em}}
\makeatother

\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{4}

\makeatletter
\newenvironment{figurehere}
  {\def\@captype{figure}}
  {}
\makeatother
\usepackage[pdfborder={0 0 0}]{hyperref}    % turns references into hyperlinks
\usepackage{verbatim}
\usepackage[utf8]{inputenc}
\usepackage{caption}
\usepackage{placeins}
\captionsetup{justification=raggedright,singlelinecheck=false}
\usepackage[none]{hyphenat}
\usepackage{graphicx}				% Allows for photos to be added
%\usepackage{parskip} 				% Stops the horrific spacing 
\usepackage[top=0cm, foot=1.5em, bottom=2.5cm, left=2cm, right=2cm]{geometry} 	% Set margins to .5 inches 
\addtolength{\topmargin}{0.5in}		% Set top margin to 1 inch
\usepackage{hyperref}				% Hyperlinks package
\hypersetup{colorlinks=true, linkcolor=blue, citecolor = blue, filecolor=black, urlcolor=blue} 	% Make types of hyperlinks
\urlstyle{same}
\usepackage{caption}				% Captions
\usepackage[none]{hyphenat}			% Stops it splitting words over two lines 
\usepackage[OT1]{fontenc}		% Font
\renewcommand*\familydefault{\sfdefault} 
\usepackage{setspace}
\setstretch{1}
\usepackage{docmute}
\usepackage{tikz}
\usetikzlibrary{matrix,chains,positioning,decorations.pathreplacing,arrows}

%\graphicspath{}			if you have trouble getting images in the thing, asks for graphics in the same folder
%\usepackage{hhline}         			% Horizontal lines in tables
\usepackage{siunitx}        			% Correct spacing of units
\usepackage{amsmath}        			% American Mathematical Society
\usepackage{amssymb}        			% Maths symbols
%\usepackage{amsthm}         			% Theorems
 \usepackage{lastpage}      			% ``n of m'' page numbering
%\usepackage{mathtools}
%\usepackage{changepage}
%\usepackage{blindtext}

%\raggedbottom                           % try to avoid widows and orphans
%\sloppy
%\clubpenalty1000%
%\widowpenalty1000%


\begin{document}

%%% TITLE PAGE %%%
\thispagestyle{empty}

\rightline{\LARGE Alexandra Riddell-Webster}

\vspace*{60mm}
\begin{center}
\Huge
\textbf{A System to Help Prevent Crashes in Rowing Boats} \\[5mm]
Computer Science Tripos -- Part II \\[5mm]
Murray Edwards College \\[5mm]
2023
\end{center}

%%% DECELERATION OF ORIGINALITY %%%
\pagestyle{plain}
\chapter*{Declaration of Originality}

I, Alexandra Riddell-Webster of Murray Edwards College, being a candidate for Part II of the Computer Science Tripos, hereby declare that this dissertation and the work described in it are my own work, unaided except as may be specified below, and that the dissertation does not contain material that has already been used to any substantial extent for a comparable purpose. \\ \\
I am content for my dissertation to be made available to the students and staff of the University. \\

\bigskip
\leftline{\textbf{Signed:} }
\includegraphics[scale=0.4]{sig.jpg} \\
Alexandra Riddell-Webster \\ \\
\leftline{\textbf{Date:}} \\ 
\today

%%% ACKNOWLEDGEMENTS %%%
\chapter*{Acknowledgements}
This dissertation owes a huge amount to Matthew Ireland, for supervising me. My UTO, Jon Crowcroft was invaluable. Thanks to Cambridge University Boat Club, in particular Patrick Ryan, Mike Taylor and Rosa Millard, for allowing me to put strange boxes on boats, advising me on communication over water and helping me evaluate the system. I also thank Duncan Barnes for discussing GPS and electronics on rowing boats with me.


%%% PROFORMA %%%
\chapter*{Proforma}

{\large
\begin{tabular}{ll}
\bf Candidate Number:   & TODO \\
\bf Project Title:  & A System to Help Prevent \\
& Crashes in Rowing Boats \\
\bf Examination:  & Computer Science Tripos -- Part II, May 2023      \\
\bf Word Count:    & TODO \footnotemark[1]   \\
\bf Code Line Count:    & TODO (yes, inc. comments) Code line count: Number of lines of code written by the student in the final version of their software. (say how this was calculated)\\
\bf Project Originator: & Alexandra Riddell-Webster                 \\
\bf Supervisor:         & Mr Matthew Ireland  \\ 
\bf University Teaching Officer:  & Dr Jon Crowcroft \\ 
\end{tabular}
}
\footnotetext[1]{TODO} % This word count was computed by \texttt{detex diss.tex | tr -cd '0-9A-Za-z $\tt\backslash$n' | wc -w} }
\stepcounter{footnote}


\section*{Original Aims of the Project}
At most 100 words on what this project aimed to do
TODO
It is quite in order for the Proforma to point out how ambitious the original aims were and how the work completed represents the triumphant consequence of considerable effort against a background of unpredictable disasters. The substantiation of these claims will follow in the rest of the dissertation.

\section*{Work Completed}
100 words on what I have done on this dis
TODO

\section*{Special Difficulties}
None.



%%% CONTENTS %%%
{
\hypersetup{linkcolor=black}
\tableofcontents
}

%%% INTRODUCTION %%%
%The introduction should explain the principal motivation for the project and show how the work fits into the broad area of surrounding computer science and give a brief survey of previous related work. It should generally be unnecessary to quote at length from technical papers or textbooks. If a simple bibliographic reference is insufficient, consign any lengthy quotation to an appendix.
\newchapter{1}{Introduction}
During this project I built a system to help prevent crashes in rowing boats. The system is implemented in hardware, cumulating in a series of boxes that can be attached to boats. The project is split into two parts. First, the mobile ad hoc network (MANET) that allows nodes to communicate a dynamic collection of known obstacles, then the application layer that warns users when they are approaching an obstacle and allows the user to add obstacles. The system will be available online, fully documented, after my gradation. This will include a `how to' guide [\hyperref[appendixA]{Appendix A}] for construction of a node so any rowing club can use my project as a collision avoidance tool.    

\section{Motivation}	
Crashes between rowing boats and obstacles or other boats injure rowers and cause equipment damage. Unfortunately, crashes are common. Figure 1.1 shows a boat on the Thames, having collided with a bridge at a regatta in March 2023. Some boats have coxswains, responsible for steering a boat, while others are coxless, where rowers who face away from the direction of travel are responsible for steering boats. This project is designed for use in both coxed and coxless boats. \\
My project has a very personal motivation, as a friend was hit by a larger rowing boat while in a single three years ago, causing a severe concussion that resulted in two years of intermission from their studies.
\begin{figure}[h]
\begin{center}
\includegraphics[scale=0.5]{boatCrash.jpg.png}
\end{center}
\caption{An eight colliding with Barnes Bridge \cite{boat}}
\end{figure}
\FloatBarrier

\section{Background}
%TODO refactor this into explaining how the project is difficult show how the project is diccifult - tell a better story here, it feels jerky with the jump from the first network to today 
The Defence Advanced Research Projects Agency (DARPA) Packet Radio Network (PRNET) \cite{prnet} was the first wireless data network, using store-and-forward routing over packet radios. Jubin and Tornow lay out the state of PRNET in 1987, nearly 15 years after research began on it, in their paper `The DARPA Packet Radio Network Protocols'. The work on PRNET fed into DARPA's Survivable Radio Network (SURAN) \cite{suran}. The connection between the military and ad hoc networking still exists today, with MANETs used in conflicts \cite{military}, as well as autonomous vehicles \cite{vehicle} and disaster relief scenarios where previously existing infrastructure is destroyed \cite{disaster}. \\ \\ 
The Open Systems Interconnection (OSI) model for computer networking provides an abstraction of the communications between computers. The OSI model consists of seven layers: Application, Presentation, Session, Transport, Network, Data Link, and Physical \cite{ib}. This project uses the libraries provided with hardware for the Physical and Data Link layers. It focusses mainly on the Networking layer, sending messages between nodes. \\ \\ 
While routing corresponds to many hops across a network, medium access control considers only one. Media access control protocols control access to the transmission media to prevent collisions between messages. 

A technical challenge faced by my project was effectively utilising the small CPU on the Raspberry Pi Pico \cite{rp2040} to propagate messages through an unpredictable dynamic topology, with nodes that frequently move at speeds of more than 15 km/h.

\section{Related Work}
\subsection{Networking}
There is precedent for using MANETs on rowing boats. I spoke the team behind the broadcasting and associated telemetry for the Oxford Cambridge Boat Race. They use a 15-node MANET to get the video and telemetry from the rowing boats. They also take GPS readings for the location of the boat, recording the location of the boat up to 20 times a second. Figure 1.2 shows the equipment they attached to the crews for the 2023 Boat Race.  
\begin{figure}[h]
\begin{center}
\includegraphics[scale=0.07]{boatrace1.jpg}           \includegraphics[scale=0.07]{boatrace2.jpg}
\end{center}
\caption{Equipment placed on the stern of the Cambridge boat \cite{mike}}
\end{figure}
\FloatBarrier

\subsection{Delay Tolerant Routing}
Delay tolerant routing assumes that networks will have lack of connectivity, with partitions between nodes. Vahdat and Becker's paper `Epidemic Routing for Partially-Connected Ad Hoc Networks'  \cite{epidemic} introduces a replication based, delay tolerant routing protocol where messages are passed onto nodes that do not have a copy of the message. Vahdat and Becker's paper is the key paper used to implement routing within this project. 

\subsection{Safety in Rowing}
ROWCUS \cite{rowcus}, a company based in Switzerland, has attempted to solve the problem of crashes in rowing boats. While ROWCUS has similar goals to my project, the technical methodologies are different, using radar rather than GPS location to detect proximity to obstacles. Additionally, ROWCUS does not network nodes together, instead using individual nodes. ROWCUS has ``decided not to pursue the commercial deployment of ROWCUS'', in a statement on their website \cite{rowcus}.


%%% PREPARATION %%%
%Principally, this chapter should describe the work which was undertaken before code was written, hardware built or theories worked on. It should show how the project proposal was further refined and clarified, so that the implementation stage could go smoothly rather than by trial and error.

%Throughout this chapter and indeed the whole dissertation, it is essential to demonstrate that a proper professional approach was employed.

%The nature of this chapter will vary greatly from one dissertation to another but, underlining the professional approach, this chapter will very likely include a section headed "Requirements Analysis" and refer to appropriate software engineering techniques used in the dissertation. The chapter will also cite any new programming languages and systems which had to be learnt and will mention complicated theories or algorithms which required understanding.

%It is essential to declare the starting point. This states any existing codebase or materials that your project builds on. The text here can commonly be identical to the text in your proposal, but it may enlarge on it or report variations. For instance, the true starting point may have turned out to be different from that declared in the proposal and such discrepancies must be explained.
\newchapter{2}{Preparation}
\setcounter{figure}{0}
\section{Starting Point} 
I had no previous hands-on experience with microcontrollers, although I had worked with single board computers. I therefore dedicated a small amount of time over the summer to learning about microcontrollers and MicroPython, completing basic tasks such as flashing an onboard LED. While this was useful, my project is implemented in CircuitPython, so it would have been more beneficial to have explored this. \\ \\
My project implemented a modified version of the Epidemic routing protocol. I had some experience with networking and routing protocols prior to starting this project. This was composed from the Part IB Networking module and two weeks' work during an internship on a MANET with different routing protocol, much further abstracted than this project. During the course of my project I took the Part II Principles of Communications course, further expanding my knowledge. 

\section{Choice of Hardware} 
Hardware was ordered before the start of term, in order to guarantee its availability for the project proposal. The main factors in my hardware choices were size, weight, power consumption and cost. Items needed to be relatively small to allow them to fit on a rowing boat. If the components were overly costly, it may prohibit other rowing clubs from producing their own networks. \\ \\
I chose to use a microcontroller to control the system due to the reduction in power consumption and costs it would offer over a single board computer. The Raspberry Pi Pico was chosen due to large peripheral set, with support for both UART, SPI, and I2C protocols. This allowed for greater flexibility throughout the project. \\ \\ %TODO - more about the raspberry pi pico, include a pinout(if allowed) ((arm based microcontroller, costing $4)
For GPS and radio, AdaFruit boards were chosen due to the strong community surrounding the hardware, with the AdaFruit boards being supported by open source libraries that allow rudimentary operations to be performed. \\
The AdaFruit RFM69 radio has an SPI interface and 500m range, appropriate for the use case as rowing boats will take around 2 minutes to cover 500m. Additionally, I chose to use the 433 MHz industrial, scientific, and medical (ISM) band as it is free to use without licencing, allowing me and other rowing clubs to use it without incurring additional costs. \\
The CD-PA1616S GPS has benefits similar to the RFM69, with community support and libraries for basic communication. It was additionally chosen as it includes a patch antenna and relatively short cold start time -- these were important for the use case, as a delay in the collision avoidance device starting up reduces the overall utility of the system.

\section{Requirements}
The three requirements I identified as my success criteria were: \\ \\
\textbf{\begin{tabular}{ll}
The Epidemic routing protocol is implemented within the network    & Achieved \\
An evaluation of the network has been carried out    & Achieved \\
A user interface has been implemented to allow utility of the network  & Achieved \\
% TODO - is there a better way to phrase this than a user interface? 
\end{tabular}} \\ \\
All of these requirements have been implemented during this project. \\ \\ 
I also laid out several extension tasks. Some of them were drawn from my research into networking protocols other than Epidemic. For instance, I wanted to use a metric for transmission quality -- received strength signal indicator (RSSI) in radio communication -- to influence whether an anti-entropy session was initiated. Additionally, the GPS location could be used, either by only contacting nearby nodes to increase the probability that an anti-entropy session is successful, or prioritising sending messages about new obstacles to nodes that are near these obstacles. While time constraints have not allowed me to implement these extensions, I have implemented an extension allowing messages to have two priorities, normal and urgent. \\ \\
% TODO - rewrite this bit to phrase how the requirements came from how I wanted the system to work and the project to be used -- some of this belongs in system design rather than requirements analysis 
% requirements were formulated from - say what the system does - break down the goal 
These requirements were based around the use case for the project -- as devices attached to rowing boats, where the nodes have high mobility. This mobility requires a high degree of flexibility within the network.
I analysed the potential topology of networks. This was done by looking at example distributions of rowing boats on lakes and rivers. One potential use case for this network that I am familiar with is the river Thames. I analysed Google Maps and Earth's satellite view of the Thames along a 5.5km stretch of the Championship Course, pinpointing rowing boats and coaching launches, then adding them to a map with potential connections between nodes, assuming the radios have a range of 500m, alongside obstacles. Figure 2.3 shows a satellite image of a single sculler, a potential node in this network. Figure 2.4 shows the marked up map of the Thames, and figure 2.5 presents the abstracted network topology of these rowing boats.
\begin{figure}[h]
\caption{A rowing boat seen on Google Earth \cite{earth}}
\begin{center}
\includegraphics[scale=0.2]{earthSculler.jpg}
\end{center}
\end{figure}
\begin{figure}[h]
\begin{center}
\includegraphics[scale=0.4]{mapsmarked.jpg}
\end{center}
\caption{Rowing boats, potential obstacles and assumed connections marked on a Google Maps map of the river Thames}
\end{figure}
\begin{figure}[h]
\begin{center}
% todo - typeset 
\includegraphics[scale=0.5]{lines.jpg}
\end{center}
\caption{The network of rowing boats in an abstracted form}
\end{figure}
\FloatBarrier

\section{Software Development Methodology}
% Descirbe waterfall and agile (its 12 tenants) and explain that you are taking from both becuse they are aimed at teams and not on eperson writign a part ii project in like 6 month
% 
% TODO -- needs improvements This project was structured using the waterfall model for software development. The project proposal [\hyperref[appendixD]{Appendix D}] lays out the phases of the project and the output from each stage in a plan of work. The waterfall model of software development was used as it lends itself to the structure of a dissertation, with the five stages: \\
% \centerline{Requirements $\rightarrow$ System Design $\rightarrow$ Implementation $\rightarrow$ Testing $\rightarrow$ Maintenance} \\ \\
% Perhaps say something instead about how you took inspiration from different parts idk?
% pick the ideas you used and the strategies they are attributed to and talk about how each part was useful 
% no feature bloat in the agile manifesto
% you split the project into blocks with milestones for achieving each part
% vaildation / testing at each point to prove that it works

\section{Choice of Programming Language}  
This project used CircuitPython, a branch of MicroPython, a version of Python for microcontrollers. CircuitPython was used as it can easily be run on the Raspberry Pi Pico. Additionally, it allowed me to use Pylint to statically analyse code. This was particularly useful as the code was run on an external Raspberry Pi Pico, so running the code to find small errors would have been an inconvenience. Additionally, the existing AdaFruit libraries I used in the project were written in CircuitPython, so keeping the whole project to the same language reduced complexity. \\ \\
GitHub was used to perform version control on the code and dissertation for this project. This also allowed me to fork repositories and submit a pull request to AdaFruit. \\ \\ 
I used Visual Studio Code as my main Integrated Development Environment as I have used it on previous project, and it offered support for CircuitPython.


\section{Summary of Research}
\subsection{MANET}
A mobile ad hoc network (MANET) is characterised by wireless nodes, a frequently changing network topology and no reliance on pre-existing infrastructure. They are decentralised and therefore have no single point of failure \cite{d2}.  This project constructs a MANET due to the lack of pre-existing infrastructure and the difficulties associated with setting up and maintaining a base station or similar. Requiring an infrastructure like this would also raise the barrier for entry for many clubs with limited funds and technical skills. Additionally, rowing boats can move between stretches of water, further supporting use of a MANET for this project.

\subsection{Routing}
Routing protocols find a path from a source to one or more destinations destination within the network. Different routing protocols optimise different parameters, and are better suited for different network topologies and applications \cite{princom}. Within MANETs, a routing protocol must allow the network topology to change over time. They tend to contain node discovery techniques to allow for this. \\ \\
Before deciding on Epidemic as the routing protocol to implement for my project, I considered several other protocols. The the Better Approach to Ad Hoc Mobile Networking (BATMAN) protocol \cite{batman} is designed to route messages through MANETs, broadcasting originator messages (OGM) for node discovery. BATMAN has the interesting addition of a transmit quality (TQ) metric in the OGM packets, allowing the quality of connections between nodes to be factored into the route packets take through the network. While BATMAN does allow messages to be broadcast to all nodes, its primary focus is routing messages from one node to another. Additionally, while it allows for message mobility, it is not delay-tolerant.\\ \\
Greedy Perimeter Stateless Routing (GPSR) \cite{gpsr} is a location based routing protocol. GPSR exploits the relation between geographic position and connectivity in a wireless network, where each node tells its immediate neighbours its current location. Greedy forwarding is predominantly used to send packets to nodes that are progressively closer to the destination, until the destination coordinates can be reached. Where greedy forwarding fails, GPSR uses perimeter forwarding (forwarding the packets around the perimeter of the region) until greedy forwarding can be used again. This protocol was ultimately deemed to be unsuitable for my project as, similar to BATMAN, its primary focus is in sending messages between two nodes. Additionally, the high mobility of the nodes in the use case means that forwarding packets to a set of coordinates does not mean the message will reach the intended destination, as the node may have moved.

\subsection{Epidemic}
% TODO - make clearer what anti-entropy is, include a diagram (you draw it yourself) that explains it
I chose to implement Epidemic in my project \cite{epidemic}. Epidemic routing gains its names from its similarity to the spreading of infections. Each node replicates and transmits messages to neighbours that have not recently been contacted. These neighbours are discovered when each node broadcasts its existence to its neighbours. Epidemic was implemented in this project because it is a delay-tolerant routing protocol and best fits the likely network topology generated by rowing boats, as detailed in the Requirements section below. The networks generated by rowing boats have a high chance of partition, but the nodes are highly mobile. As Epidemic allows any node to carry network information it is best suited to the network. Additionally, Epidemic supports a broadcast functionality, sending messages to every node in the network, which is necessary for the use case as every boat should hear about potential obstacles. \\  % Antientropy as a subsection?
The term `anti-entropy', as used in my dissertation, comes from this paper. An anti-entropy session occurs when two nodes come into communication range and exchange messages. 
Anti-entropy -- message exchange -- within Epidemic is initiated by the node with the lower ID. These lower ID node initiates anti-entropy by sending a summary vector a, representative of the messages they have to another node. This node calculates logical AND between this summary vector and the negation of its own summary vector to produce the messages it has not seen that the other node has. It requests these messages. The node with the higher ID then sends its updated summary vector to the other node, and the node with the lower ID requests any messages it has not seen before. After a successful message exchange, the node is added to a list of recently contacted nodes, preventing anti-entropy from being conducted many times between two sets of nodes. This list is periodically cleared. 

\subsection{Media Access Control}
While these routing protocols often have mechanisms to minimise the probability of collisions, such as adding a jitter in the sending of discovery messages, none of them contain medium access control. Due to the probability of collisions between messages causing disruption to the sending of messages, particularly as all nodes are broadcasting on the same radio frequency (433 MHz). It was  therefore prudent to include media access control in the system. Multiple Access with Collision Avoidance for Wireless (MACAW) is often used by ad hoc networks. MACAW uses request to send (RTS) and clear to send (CTS) messages to minimise the probability of collision. As discussed in the System Design section, MACAW inspired the medium access control in my project. 

%\section{Timeline} 
% TODO add the actual timeline vs the proceded or assumed timeline
% a gant chart here - try pgf tics in latex? 




%%% IMPLEMENTATION %%%
\newchapter{3}{Implementation}
\setcounter{figure}{0}
% talk about the end of each stage where you tested the components 

%This chapter should describe what was actually produced: the programs which were written, the hardware which was built or the theory which was developed. Any design strategies that looked ahead to the testing stage should be described in order to demonstrate a professional approach was taken.

%Descriptions of programs may include fragments of high-level code but large chunks of code are usually best left to appendices or omitted altogether. Analogous advice applies to circuit diagrams or detailed steps in a machine-checked proof.
 
% Split into major blocks with the testing at the end ``It should not be necessary to give a day-by-day account of the progress of the work but major milestones may sometimes be highlighted with advantage.''

%Should definately make a new state machine / UML diagram to show how the code now works 

%On delays (back-off etc.) -- the delays currently seem quite long, and there'll need to be some justification in the Implementation chapter for how you chose the length of the delays. Usually I'd expect delays of the order of milliseconds rather than seconds. A sensible way to choose the delays would be: on your oscilloscope, time the total length of time required to complete one full exchange with another node, and then set the default back-off to that (and take a similar approach to any other delays in the program).
 
%talk about the name change

%They do assume you can program so don't overley detail how your code is structured.

% Block diagram UML diagram  - how did you put this system together? 

Highlight the requirements as you achieve them
\section{Open Source}
Not open source until graduation. Why? Make it clear you want it to be open source all the way and the rules around plagiarism are stopping you



\section{System Design}
Having decided on the Epidemic routing protocol, I planned the structure of the software that would run on each node. I knew that the Raspberry Pi Pico uses the RP2040 chip, containing two cores. To make best use of the hardware, I decided to design application and networking threads that would run on each core, with global data structures and concurrency control to pass messages between the two layers and allow both of them to access the GPS board. \\ \\
%TODO you should talk about the flooding state machine you designed and the similarities between eidemic and flooding \\ \\ 
The application thread is responsible for notifying the user when they are too close to an obstacle. It also takes input from the user, generating new obstacles when a button is pressed. The initial state machine is shown in Figure 2.4. The a time to live (TTL) for each obstacle. If the object is permanent, such as a bridge, the TTL is set to $-1$, indicating that it should never be removed.
\begin{figure}[h]
\begin{center}
% TODO - typeset 
\includegraphics[scale=0.5]{appThread.jpg}
\caption{The initial state machine for the application thread}
\end{center}
\end{figure}
\FloatBarrier
The networking thread contains the implementation of Epidemic with media access control. While routing and medium access control are typically handled separately -- in the OSI model they are in the second and third layers respectively -- they were considered together for my project to prevent work being repeated and use the limited computing resources available most effectively. This means that the implementation of Epidemic will also change. Not only will the node refuse to send any messages after hearing a CTS for a set period of time, or until it hears an ACK, I also integrated the message vector exchange at the start of an anti-entropy session into the CTS and RTS messages. This minimised the number of packets sent over the network, reducing the overall probability of collisions or errors in transmission. This state machine has changed slightly since it was first designed. 
\begin{figure}[h]
\begin{center}
\caption{The initial state machine for the networking thread}
\includegraphics[scale=0.5]{net.jpg}
\end{center}
\end{figure}
\FloatBarrier
%TODO -- talk about data structures -- The data structures designed to communicate messages between one thread and the other are  \\ \\
While these state machines were broadly implemented, the overall structure of the software changed, with only one thread running due to the limitations of CircuitPython and difficulties transitioning into MicroPython.


% The initial idea here is to for a routing or application layer to push data onto the queue
% The network layer tkaes care of deduplication?

\section{Point to Point / radio}
Talk about the width of wire antenna (quarter wave whip antenna) having an impact on the range. 

\section{Epidemic}
Talk about all the changes you made and perhaps generate a new state machine that shows the final epidemic you used - ``history of changed decisions''

Fixed length packets removed issues 


What edge cases did we consider and deal with? When messages are identical 
When messages is empty 
When one is empty and other isn't


Some nice diagrams for packet structure and how they are sent (how about one of those diagrams with two lines for time and messages sent between them

Justify your choices of timeout etc

Also the TTL started as being time based and became number of hops (moves into extension where one is sent with more hops -> will propagate through the network faster (you didn't actually test this...)
Debugging when connected to an external power source was actually awful I have never hated antthing so much 

\section{GPS} 
Took a little while to get this to work - why? Not picking up

Duncan - Kahurman fileter - could Guassian filter to remove noise from the GPS (scope creep!)
 

\section{MicroPython}
only one thread running due to the limitations of CircuitPython. 
Therefore tried to port to MicroPython
Had one on MicroPython and one on circuitpython and tried to get the two talking
Can't multithread in CircuitPython (what is needed to natively (natively?) run the libraries for the AdaFruit modules

Turns out getting circuitpython to port in micropython is like 8 levels of dependency nightmare

Trying to get circuitpython libraries to work with micropython using Blinka


\section{User Interface}
The name should probably be changed- it really is just a button, led and buzzer
Choices of button, resistors to change buzzer pitch, LED to allow more accessibility

Momentary but not locking to make life easier for the user 
Waterproof
Large



\section{Repository Overview}
The implementation chapter should include a section labelled "Repository Overview". The repository overview should be around one page in length and should describe the high-level structure of the source code found in your source code repository. It should describe whether the code was written from scratch or if it built on an existing project or tutorial. Making effective use of powerful tools and pre-existing code is often laudable, and will count to your credit if properly reported. Nevertheless, as in the rest of the dissertation, it is essential to draw attention to the parts of the work which are not your own.

GPS library almost entirely not mine
RFM69 grey area - built off others' but I expanded with fixed length packets? 


%%% EVALUATION %%%
\newchapter{4}{Evaluation}
\setcounter{figure}{0}
The majority of the evaluation was conducted according to the plan in Appendix B [\hyperref[appendixB]{Appendix B}]. It was split into a performance evaluation of the MANET then a more qualitative evaluation of the whole system.

\section{Evaluating the MANET}
The evaluation of the MANET was designed to mirror the evaluation performed by Vahdat and Becker's paper, with the key difference that my project was implemented in hardware, while theirs was virtualised.
% todo - add more comparisons


\subsection{Latency}
The latency of the system was as the time between a node being generated at node A and received at node B. Node B was then moved further away from node A, eventually moving to 500m away with an interim node, C. The distances between nodes were 0, 10, 100, 250 and 500 metres. 60 messages were generated by A at each distance. Figure 4.1 shows the setup, with radio connections between nodes marked in blue. \\ \\ 
\begin{figurehere}
\begin{center}
\begin{tikzpicture}[
roundnode/.style={circle, draw=black, very thick, minimum size=20mm},
squarednode/.style={circle, draw=black, very thick, minimum size=20mm},
]
%Nodes
\node[squarednode]      (maintopic)                              {\Huge A};
\node[roundnode]        (uppercircle)       [right =3cm  of maintopic] {\Huge B};

%Lines
\draw[line width=0.5mm, blue] (maintopic) -- (uppercircle);
\end{tikzpicture} \\
\begin{tikzpicture}[
roundnode/.style={circle, draw=black, very thick, minimum size=20mm},
squarednode/.style={circle, draw=black, very thick, minimum size=20mm},
morenode/.style={circle, draw=black, very thick, minimum size=20mm},
]
%Nodes
\node[squarednode]      (maintopic)                              {\Huge A};
\node[morenode]        (morenode)       [right =3cm  of maintopic] {\Huge C};
\node[roundnode]        (uppercircle)       [right =3cm  of morenode] {\Huge B};

%Lines
\draw[line width=0.5mm, blue] (maintopic) -- (morenode);
\draw[line width=0.5mm, blue] (morenode) -- (uppercircle);
\end{tikzpicture}
\end{center}
\caption{The network used for latency testing}
\end{figurehere}



Figure 4.2 shows the percentage of packets delivered over time. Figure 4.3 breaks down the data behind this, showing the times that each packet arrived at each distance. It is unsurprising to find that the charts for 0 and 10 metres differ little, with an average delivery time of 15.0 and 15.7 seconds respectively. The 100 metre interval follows a similar pattern. There is then a significant drop off when the distance is increased to 250 and 500 metres, likely because more than one hop needed to be used to move messages from one node to another. There is a significant increase in the standard deviation, due to the increased variability from passing messages over multiple nodes. \\ \\
%TODO relate to the speed of rowing boats being 
\begin{figure}
\begin{center}
\input{percentages.pgf}
\end{center}
\caption{The percentage of packets delivered with time}
\end{figure}
\begin{figure}
\begin{center}
\input{distanceIntervals.pgf}
\end{center}
\caption{The time taken to deliver messages over distance intervals}
\end{figure}

\begin{table}
\begin{center}
\begin{tabular}{ |c|c|c|c|c| } 
\hline
Distance & Average Delivery (seconds) & Standard Deviation \\ 
\hline
0 & 15.045454545454545 & 13.795510708287654 \\ 
\hline
10 & 15.703125 & 16.1986493336443 \\ 
\hline
100 & 34.91428571428571 & 37.96605358066329 \\ 
\hline
250 & 151.74137931034483 & 126.72064855622898 \\ 
\hline
500 & 233.35714285714286 & 138.67941300653365 \\ 
\hline
\end{tabular}
\end{center}
\caption{Average delivery and standard deviation in seconds}
\end{table} 

\FloatBarrier

\subsection{Bandwidth}
Testing the bandwidth of the system was done with the aim of working out how many messages the system can cope with. In reality, it is unlikely the MANET will need to process as many messages as in this test. Bandwidth testing was conducted between two nodes, with one node generating messages at a set rate and broadcasting them to the other node. Messages were generated at an increasing rate until the number of messages received by node B plateaued. Figure 4.4 shows the setup for this test. \\ \\
As shown in figure 4.5, the MANET has a relatively low bandwidth, with plateauing at around 0.35 messages transferred on average each second, equivalent to taking around 3 seconds to pass one message from node to node. To improve the bandwidth of the system, I could decrease the time between discovery (`hello') packets sent by each node. 

\begin{figurehere}
\begin{center}
\begin{tikzpicture}[
roundnode/.style={circle, draw=black, very thick, minimum size=17mm},
squarednode/.style={circle, draw=black, very thick, minimum size=17mm},
]
%Nodes
\node[squarednode]      (maintopic)                              {\Huge A};
\node[roundnode]        (uppercircle)       [right =3cm  of maintopic] {\Huge B};

%Lines
\draw[line width=0.5mm, blue] (maintopic) -- (uppercircle);
\end{tikzpicture} 
\end{center}
\caption{The network used for bandwidth testing}
\end{figurehere}

\begin{figure}
\begin{center}
\input{bandwidth.pgf}
\end{center}
\caption{The bandwidth of a fully connected two node network with an increasing number of messages generated each second}
\end{figure}

\subsection{Percentage of Packets Delivered}
Throughout testing, 100\% of packets were delivered. This is best illustrated by the test with five nodes. To run this test, I recruited four volunteers to move around a large field, approximately 500 x 500 metre area. This allowed nodes to move in and out of range of each other. Each node had a 0.1 probability of generating a message, with up to 30 messages being generated. The nodes moved around this test area for approximately 15 minutes. This is a reduced version of the evaluation performed in Vahdat and Becker's paper \cite{epidemic}, where 50 nodes were simulated within a 1500 x 300 metre area. \\
While this test was run three times, only two of the results can be used due to a loose connection meaning a node did not work on the second run. In both these tests, 100\% of packets were delivered.
% TODO perhpas do a perentage delivered over time or something? IDK 

% TODO you can definately do better on this evaluation than this...

\subsection{Partition Testing}
Partition testing was conducted with four nodes in two pairs. Each pair was set up to communicate with each other, then brought into range of the other pair. Figure 4.6 shows the starting (above) and finishing (below) states of the network. 
\begin{figurehere}
\begin{center}
\begin{tikzpicture}[
a/.style={circle, draw=black, very thick, minimum size=17mm},
b/.style={circle, draw=black, very thick, minimum size=17mm},
c/.style={circle, draw=black, very thick, minimum size=17mm},
d/.style={circle, draw=black, very thick, minimum size=17mm},
]
%Nodes
\node[a] (aa) {\Huge A};
\node[b] (bb) [below=2cm of aa] {\Huge B};
\node[c] (cc) [right=5cm of aa] {\Huge C};
\node[d] (dd) [right=5cm of bb] {\Huge D};

%Lines
\draw[line width=0.5mm, blue] (aa) -- (bb);
\draw[line width=0.5mm, blue] (cc) -- (dd);
\end{tikzpicture}  \\



\begin{tikzpicture}[
a/.style={circle, draw=black, very thick, minimum size=17mm},
b/.style={circle, draw=black, very thick, minimum size=17mm},
c/.style={circle, draw=black, very thick, minimum size=17mm},
d/.style={circle, draw=black, very thick, minimum size=17mm},
]
%Nodes
\node[a] (aa) {\Huge A};
\node[b] (bb) [below=2cm of aa] {\Huge B};
\node[c] (cc) [right=2cm of aa] {\Huge C};
\node[d] (dd) [right=2cm of bb] {\Huge D};

%Lines
\draw[line width=0.5mm, blue] (aa) -- (bb);
\draw[line width=0.5mm, blue] (aa) -- (cc);
\draw[line width=0.5mm, blue] (aa) -- (dd);
\draw[line width=0.5mm, blue] (bb) -- (dd);
\draw[line width=0.5mm, blue] (bb) -- (cc);
\draw[line width=0.5mm, blue] (cc) -- (dd);
\end{tikzpicture} 
\end{center}
\caption{The network used for latency testing}
\end{figurehere}

\subsubsection{Asymmetric}
Asymmetric partition testing consisted of the \{A, B\} pair holding 30 messages before partition. After partition, the \{C, D\} pair had all messages. Over 2 partitions, the average time taken for all nodes in the network to hold the same messages was 106.5 seconds. Given the approximate speed of a rowing boat is 15km/h, and the radio range is 500m, this would allow two boats to be in range for 120 seconds, just enough time for the maximum number of messages to be transferred between two boats.  \\ \\
\begin{table}
\begin{center}
\begin{tabular}{ |c|c|c| } 
\hline
Run & Time for Node C (seconds) & Time for Node D (seconds) \\ 
\hline
1 & 50 & 135 \\ 
\hline
2 & 78 & 44  \\ 
\hline
\end{tabular}
\end{center}
\caption{Time taken for all messages to be received in asymmetric partitions}
\end{table}  

\subsubsection{Symmetric}
Symmetric evaluation of the network gave the two pairs of nodes different sets of messages.
The average time for nodes to receive all 30 messages was 130 seconds, 23.5 seconds greater than an asymmetric partition.
\begin{table}
\begin{center}
\begin{tabular}{ |c|c|c|c| } 
\hline
Node A & Node B & Node C & Node D \\ 
\hline
87 & 159 & 145 & 129 \\ 
\hline
\end{tabular}
\end{center}
\caption{Time taken in seconds for all messages to be received in symmetric partitions}
\end{table}  % TODO the four node partition nonsense

\section{Evaluating the System}
\subsection{On Water} 
The water evaluation was conducted last. I was concerned that there might be an accident and the project become water damaged or fall into the river, so all trials before this were conducted on land. The system did work on rowing boats, notifying rowers of other boats with the technology and of registered obstacles. \\
I examined the GPS tracking on water as I was concerned that bridges or similar obstructions to the sky would interfere with the GPS tracking on each boat. This would be of particular concern as a bridge could be considered an obstacle. Figure 4.7 shows the GPS trace underneath a bridge. While the error caused by the bridge is minimal, it could be improved by applying a Gaussian or Kalman filter, as done in other GPS tracking for rowing boats. An issue this experiment inadvertently highlighted is that the trace does not appear to be accurate, showing the boat moving along the ground at some points. When comparing this to the GPS points taken in later experiments, this does not seem to be a systematic error, instead a random error in the placement of the GPS in that outing. This suggests that an obstacle may be recorded in the wrong place due to an inaccurate GPS reading.
\begin{figure}[h]
\begin{center}
\includegraphics[scale=0.3]{bridgeGPS.jpg}
\end{center}
\caption{The GPS tracking taken by a node, shown on Google Maps \cite{googlemapsgeneral}}
\end{figure}
To evaluate the system I went rowing with a volunteer, each of us with a device on our boat. We ensured that the boats were notified when they were approaching each other. We found this notification to come at around 10 metres between boats. However, when the boats are rowing alongside one another, with no chance of collision, they continually alert the user to the other boat. (N.B. Matthew -- I am currently trying to add a unique ID for each obstacle so this does not occur :) )\\
The nodes also transfer knowledge of obstacles between them. To test this, one boat went further up the river and registered a `new obstacle' at a pre-agreed point (shown in figure 4.8, opposite the Goldie Boat House) by pressing the button on the device. The first boat then returned to the second, who rowed towards the potential obstacle. This gave a time delay between the rowers, showing that messages are propagated through the network to warn other boats of the obstacles. The node warned the other boat of the obstacle. 
\begin{figure}[h]
\begin{center}
\includegraphics[scale=0.3]{obstacle.jpg}
\end{center}
\caption{The registered obstacle as a red marker on Google Maps \cite{googlemapsgeneral}}
\end{figure}

% TODO also update the evaluation plan with the correct sizes (not 20m) and what you actually did

\subsection{Qualitative Evaluation}
For a qualitative evaluation, I surveyed the rower in the other single. While their overall impression was positive, the survey highlighted extra work that needed to be done to the user interface. They pointed out that the buzzer, even if the bug for notifying users about boats they are rowing alongside is fixed, may be a violation of rules about noise during certain times, so it could include another button to turn off the buzzer if needed. \\
There are some limitations to the system due to its design. The format of the packets has meant that there can be at most 255 nodes in the system, as there are two bytes reserved for the node address and address 0 is reserved for broadcast. The number of obstacles stored in memory is limited by the available memory on the chip, and at 2Mb this is effectively infinite. However, the message buffer is limited at 30. This limit on the number of messages a node can propagate is placed there to allow the unique ID for each message to fit into a single 64 byte packet, but means that the maximum number of obstacles a node can pass to a neighbour is 30.

%%% CONCLUSION %%%
\newchapter{5}{Conclusion}
This dissertation has presented a system to help prevent crashes in rowing boats. The system propagates knowledge about obstacles through a network of rowing boats using the Epidemic routing protocol.

\section{Summary}
In the introduction, I highlighted the issues around crashes in rowing boats and the need for a system to help prevent such crashes. This dissertation has presented such a system, propagating knowledge about obstacles through a network of rowing boats using the Epidemic routing protocol. 

The project met and exceeded the success criteria.


What have you done?
In this project I have 

The evaluation shows that. This project is weak in. Low bandwidth

\section{Reflections}
The preparation chapter lays out the choices I made with respect to the software development methodology, tools and programming language. These choices were all found to be effective in deigning and building the system. It was particularly helpful to have a plan that split the project into stages with defined deliverables at each stage. \\ \\ 
While the research phase is designed to cover broad parts of the area in order to find the best solution to a problem, I spent too much time researching various potential routing protocols. With the benefit of hindsight, it would have been beneficial to settle on the Epidemic routing protocol earlier in the process. \\ \\
There were both upsides and downsides to implementing the project in hardware. It taught me huge amounts 
about serial communication protocols and other low level implementation details. It also allowed for a more holistic approach to the evaluation, using the system on rowing boats. However, it is undeniable that the low level details made some aspects of the project more difficult, particularly when it came to debugging a problem. For instance, I had soldered an antenna to a radio module in such a way that caused errors in the received packets, a problem I did not diagnose until I swapped the module for another one. 

\section{Future Work}
There is future work that could be conducted in relation to both the networking and application components of the project. \\ \\
Some of the networking extensions were drawn from my research into networking protocols other than Epidemic. For instance, as in GPSR, the GPS location could be used, either by only contacting nearby nodes to increase the probability that an anti-entropy session is successful. The location could also be used to prioritise sending messages about new obstacles to nodes that are near these obstacles.  A metric for transmission quality, in radio communication, the received strength signal indicator (RSSI), to influence whether an anti-entropy session was initiated. \\ \\ 
The application component could be further improved by taking the direction of the rowing boat into account when notifying the user of an obstacle. The GPS could be further improved by applying a Guassian or Kalman filter to reduce the noise in the location, particularly under bridges. Additional improvements could be made from the suggestions of users, such as a switch to mute the buzzer. 


%%% BIBLIOGRAPHY  %%%
% TODO -- why has this kille any capitalization in the names of the references? E.g. DARPA
\addcontentsline{toc}{chapter}{Bibliography}
\bibliographystyle{IEEEtran}
\bibliography{refs}


%%% APPENDICES %%%
\chapter*{Appendices}
\addcontentsline{toc}{chapter}{Appendices}  

\section*{A -- Guide to Building a Node}
\label{appendixA}
\addcontentsline{toc}{section}{A -- Guide to Building a Node}  
\setcounter{chapter}{0}
\setcounter{figure}{0}

\newpage
\section*{B -- Evaluation Plan}
\label{appendixB}
\addcontentsline{toc}{section}{B -- Evaluation Plan}  
\setcounter{figure}{0}
\input{evaluationPlan}

\newpage
\section*{C -- Progress Report}
\label{appendixC}
\addcontentsline{toc}{section}{C -- Progress Report}  
\setcounter{figure}{0}
\input{progressReport}

\newpage
\section*{D -- Project Proposal}
\label{appendixD}
\addcontentsline{toc}{section}{D -- Project Proposal}  
\setcounter{figure}{0}
\input{phase3}

\end{document}